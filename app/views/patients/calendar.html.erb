<h2 style="margin-bottom: 20px; font-size: 22px; font-weight: bold; color: #333;">ğŸ’Š ãŠè–¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>

<!-- âœ… 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
<div style="max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr; gap: 30px;">

  <!-- âœ… å·¦ã‚«ãƒ©ãƒ  -->
  <div>
    <!-- å‡¦æ–¹è–¬ä¸€è¦§ -->
    <h3 style="font-size: 18px; margin-bottom: 10px; color: #444;">å‡¦æ–¹è–¬ä¸€è¦§</h3>
    <table style="width:100%; border-collapse: collapse; text-align:center; font-size: 14px; margin-bottom: 20px;">
      <thead style="background: #f1f3f5;">
        <tr>
          <th style="border: 1px solid #ddd; padding: 6px;">è–¬å</th>
          <th style="border: 1px solid #ddd; padding: 6px;">æ®‹é‡</th>
          <th style="border: 1px solid #ddd; padding: 6px;">è¡¨ç¤º</th>
        </tr>
      </thead>
      <tbody>
        <% @received_prescriptions&.each do |prescription| %>
          <% prescription.prescription_items.each do |item| %>
            <% if item.medication %>
              <% completed_at = prescription.status_updates.where(status: :completed).order(created_at: :desc).first&.created_at %>
              <% days_passed = completed_at ? (Date.today - completed_at.to_date).to_i : 0 %>
              <% remaining = [item.days - days_passed, 0].max %>
              <tr>
                <td style="border: 1px solid #ddd; padding: 6px;"><%= item.medication.name %></td>
                <td style="border: 1px solid #ddd; padding: 6px;"><%= remaining %>æ—¥åˆ†</td>
                <td style="border: 1px solid #ddd; padding: 6px;">
                  <input type="checkbox" class="med-toggle" data-med="<%= item.medication.name %>" checked>
                </td>
              </tr>
            <% end %>
          <% end %>
        <% end %>
      </tbody>
    </table>

    <!-- ä»Šæ—¥ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <h3 style="font-size: 18px; color: #444; margin: 0 0 8px;">ğŸ“… ä»Šæ—¥ã®ãŠè–¬ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
    <div id="day-schedule"></div>
  </div>

  <!-- âœ… å³ã‚«ãƒ©ãƒ ï¼ˆæœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰ -->
  <div>
    <div id="calendar"></div>

    <!-- å‡¡ä¾‹ -->
    <div id="calendar-legend" style="margin-top: 15px; padding: 10px; background: #fafafa; border: 1px solid #ddd; border-radius: 6px; display: flex; justify-content: center; gap: 20px; font-size: 13px; color: #444;">
      <span>ğŸŒ… æœ</span>
      <span>â˜€ï¸ æ˜¼</span>
      <span>ğŸŒ† å¤•</span>
      <span>ğŸŒ™ å°±å¯å‰</span>
      <span>ğŸ½ï¸ æ¯é£Ÿå¾Œ</span>
    </div>
  </div>
</div>

<!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
<div style="margin-top: 1.5em;">
  <%= link_to "æ‚£è€…ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹", patient_home_path, class: "btn btn-secondary", style: "padding: 6px 14px; font-size: 14px;" %>
</div>

<!-- FullCalendar èª­ã¿è¾¼ã¿ -->
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js", defer: true %>

<!-- âœ… è¿½åŠ CSS: ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’å¿…ãšä¸€åˆ—ã« -->
<style>
  .fc .fc-toolbar {
    display: flex !important;
    justify-content: space-between;
    align-items: center;
    flex-wrap: nowrap;       /* âœ… æ”¹è¡Œç¦æ­¢ */
  }
  .fc .fc-toolbar-title {
    font-size: 16px;         /* âœ… ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­—ã‚’å°‘ã—æŠ‘ãˆã‚‹ */
    white-space: nowrap;     /* âœ… æŠ˜ã‚Šè¿”ã•ãªã„ */
    overflow: hidden;
    text-overflow: ellipsis; /* âœ… é•·ã™ããŸã‚‰çœç•¥ */
  }
  .fc .fc-button {
    font-size: 12px;
    padding: 2px 6px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    function getSelectedMeds() {
      return Array.from(document.querySelectorAll(".med-toggle:checked"))
                  .map(cb => cb.dataset.med);
    }

    // === æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===
    var calendarEl = document.getElementById("calendar");
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      locale: "ja",
      headerToolbar: {
        left: "title",
        center: "",
        right: "today prev,next"
      },
      buttonText: { today: "ä»Šæ—¥" },
      events: function(fetchInfo, successCallback, failureCallback) {
        var selectedMeds = getSelectedMeds();
        var query = selectedMeds.length > 0 ? "?meds=" + selectedMeds.join(",") : "";
        fetch("<%= calendar_events_patients_path(format: :json) %>" + query)
          .then(r => r.json())
          .then(data => successCallback(data))
          .catch(err => failureCallback(err));
      },
      height: "auto"
    });
    calendar.render();

    // === æ—¥å˜ä½ã‚¿ã‚¤ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« ===
    var dayScheduleEl = document.getElementById("day-schedule");
    var daySchedule = new FullCalendar.Calendar(dayScheduleEl, {
      initialView: "timeGridDay",
      locale: "ja",
      slotMinTime: "06:00:00",
      slotMaxTime: "24:00:00",
      allDaySlot: false,
      displayEventTime: false,
      eventOverlap: true,
      slotEventOverlap: true,
      headerToolbar: {
        left: "title",
        center: "",
        right: "today prev,next"
      },
      buttonText: { today: "ä»Šæ—¥" },
      events: function(fetchInfo, successCallback, failureCallback) {
        var selectedMeds = getSelectedMeds();
        var query = selectedMeds.length > 0 ? "?meds=" + selectedMeds.join(",") : "";
        fetch("<%= day_schedule_events_patients_path(format: :json) %>" + query)
          .then(r => r.json())
          .then(data => successCallback(data))
          .catch(err => failureCallback(err));
      },
      height: "480px"
    });
    daySchedule.render();

    // âœ… ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã«ä¸¡æ–¹æ›´æ–°
    document.querySelectorAll(".med-toggle").forEach(function(cb) {
      cb.addEventListener("change", function() {
        calendar.refetchEvents();
        daySchedule.refetchEvents();
      });
    });
  });
</script>






