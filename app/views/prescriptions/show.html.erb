<h1>処方箋の詳細</h1>

<table>
  <tr>
    <th>ユーザー番号</th>
    <td><%= @prescription.patient.patient_number %></td>
  </tr>
  <tr>
    <th>患者</th>
    <td><%= @prescription.patient.name %></td>
  </tr>
  <tr>
    <th>病院名</th>
    <td><%= @prescription.hospital_name %></td>
  </tr>
  <tr>
    <th>医師</th>
    <td><%= @prescription.doctor.name %></td>
  </tr>
  <tr>
    <th>発行日</th>
    <td><%= @prescription.issued_at.strftime("%Y年%m月%d日") %></td>
  </tr>
  <tr>
    <th>有効期限</th>
    <td><%= @prescription.expires_at.strftime("%Y年%m月%d日") %></td>
  </tr>
  <tr>
    <th>QRトークン</th>
    <td><%= @prescription.qr_token %></td>
  </tr>
</table>

<hr>

<h2>処方された薬</h2>
<% if @prescription.prescription_items.any? %>
  <table>
    <thead>
      <tr>
        <th>薬名</th>
        <th>用量／１回</th>
        <th>服用タイミング</th>
        <th>日数</th>
      </tr>
    </thead>
    <tbody>
      <% @prescription.prescription_items.each do |item| %>
        <tr>
          <td><%= item.medication.name %></td>
          <td><%= item.medication.dosage %></td>
          <td>
            <%= case item.medication.timing
                when "morning"    then "朝"
                when "noon"       then "昼"
                when "evening"    then "夕方"
                when "bedtime"    then "就寝前"
                when "after_meal" then "毎食後"
                else item.medication.timing
                end %>
          </td>
          <td><%= item.days %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>登録された薬はありません。</p>
<% end %>

<%# 💊 薬局ログイン時のみステータス操作を表示 %>
<% if current_user&.pharmacy? %>
  <div style="margin-top: 1em;">
    <% latest_status = @prescription.status_updates.order(created_at: :desc).first %>

    <% if latest_status&.status == "accepted" %>
      <%= button_to "調剤開始", update_status_prescription_path(@prescription, status: :processing),
                    method: :post, class: "btn btn-primary" %>
    <% elsif latest_status&.status == "processing" %>
      <button class="btn btn-secondary" disabled>調剤中</button>
    <% elsif latest_status&.status == "completed" %>
      <button class="btn btn-success" disabled>受け渡し済み</button>
    <% else %>
      <button class="btn btn-secondary" disabled>調剤不可</button>
    <% end %>
  </div>
<% end %>

<hr>

<h2>現在のステータス</h2>
<% if @prescription.status_updates.any? %>
  <% latest_status = @prescription.status_updates.order(created_at: :desc).first %>
  <p>
    <strong><%= latest_status.status_label %></strong>
    （更新者: <%= latest_status.pharmacy&.name || "患者" %> /
     更新日時: <%= latest_status.created_at.strftime("%Y年%m月%d日 %H:%M") %>）
  </p>
<% else %>
  <p>医師作成済み</p>
<% end %>

<hr>

<h2>ステータス更新履歴（最新のみ）</h2>
<% if @prescription.status_updates.any? %>
  <% latest_statuses = @prescription.status_updates
                      .group_by(&:status)
                      .transform_values { |records| records.max_by(&:created_at) } %>

  <ul>
    <% ["pending", "accepted", "processing", "completed"].each do |status| %>
      <% if latest_statuses[status] %>
        <li>
          <%= latest_statuses[status].pharmacy&.name || "患者" %>：
          <%= case status
              when "pending"    then "患者が保有中"
              when "accepted"   then "薬局受付済み"
              when "processing" then "調剤開始"
              when "completed"  then "受け渡し"
              end %>
          (<%= latest_statuses[status].created_at.strftime("%Y年%m月%d日 %H:%M") %>)
        </li>
      <% end %>
    <% end %>
  </ul>
<% else %>
  <p>医師作成済み</p>
<% end %>

<hr>

<% if current_user&.doctor? %>
  <%# 👨‍⚕️ 医師ログイン時のみ操作リンク表示 %>
  <div style="display: flex; gap: 10px; align-items: center;">
    <%= link_to "この処方箋のQRコードを表示",
                qrcode_prescription_path(@prescription),
                class: "btn btn-primary" %>

    <%= button_to "この処方箋を削除",
                  @prescription,
                  method: :delete,
                  data: { turbo_confirm: "本当に削除しますか？" },
                  class: "btn btn-danger" %>
  </div>

  <div style="margin-top: 1em;">
    <%= link_to "この処方箋を編集", edit_prescription_path(@prescription) %> |
    <%= link_to "処方箋一覧へ戻る", prescriptions_path %>
  </div>

<% elsif current_user&.pharmacy? %>
  <%# 💊 薬局ログイン時はナビリンクを表示 %>
  <div style="margin-top: 1em; display: flex; gap: 15px; align-items: center; justify-content: flex-start;">
    <%= link_to "処方箋を読み込み（QRコード）へ戻る", scan_qr_pharmacies_path, class: "btn btn-secondary" %>
    <span style="color: #888;">|</span>
    <%= link_to "受付中の処方箋一覧へ戻る", accepted_prescriptions_pharmacies_path, class: "btn btn-secondary" %>
    <span style="color: #888;">|</span>
    <%= link_to "薬局トップページへ戻る", pharmacy_home_path, class: "btn btn-secondary" %>
  </div>

<% elsif current_user&.patient? %>
  <%# 👤 患者ログイン時のみ受け取りボタンを表示 %>
  <div style="margin-top: 1em;">
    <% latest_status = @prescription.status_updates.order(created_at: :desc).first %>

    <% if latest_status.nil? || latest_status.status == "pending" %>
      <%= button_to "この処方箋を受け取る",
                    receive_prescription_path(@prescription),
                    method: :post,
                    class: "btn btn-success",
                    data: { turbo_confirm: "この処方箋を受け取りますか？" } %>
    <% else %>
      <button class="btn btn-secondary" disabled>この処方箋を受け取り済み</button>
    <% end %>
  </div>

  <div style="margin-top: 1em;">
    <%= link_to "患者トップページへ戻る", patient_home_path, class: "btn btn-secondary" %>
  </div>
<% end %>























